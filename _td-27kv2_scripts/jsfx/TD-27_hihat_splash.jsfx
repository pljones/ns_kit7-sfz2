desc: TD-27 Hi-hat Splash detector (pljones)
author: Peter L Jones (with Claude Haiku 4.5 - Mistral failed, ChatGPT failed - updated by cursor "auto" mode)
version: 4.1
about: based on https://www.megadrum.info/content/hihat-pedal-settings New Algrthm description
source: https://raw.githubusercontent.com/pljones/ns_kit7-sfz2/refs/heads/main/_td-27kv2_scripts/jsfx/TD-27_hihat_splash.jsfx

// MegaDrum uses the analogue variable pedal controller readings to drive its Chick/Note triggering.
// This assumes MIDI CC4 is an equivalent but that a MIDI Hi-hat Chick Note will be issued at some point by the module.
// The intent is to turn this into a MIDI Hi-hat Splash Note, when applicable (in accordance with the settings).
// The eDRUMin algorithm does not sound appropriate, expecting the receiver to determing whether the note is a Chick or Splash
// based on Note On to Note Off duration.  The aim here is to be explicit.

// I hope the default "600ms" can be lowered.

slider1:chickNote=44<0,127,1>Chick Note (to detect)
slider2:splashNote=97<0,127,1>Splash Note (to emit)
slider3:closedSide=1<0,1,1{Keyboard (CC4=0 Closed),eKit (CC4=127 Closed)}>Hi-hat type
slider4:chickHeld=600<0,2000,10>Chick threshold (ms)
slider5:minVel=400<100,1000,10>Min Velocity
slider6:maxVel=900<100,1000,10>Max Velocity
slider7:velSensitivity=0.5<0,1,0.05>Velocity Sensitivity
slider8:curveType=2<0,5,1{Linear,Log,Exp1,Exp2,S-Curve,Strong}>Velocity Curve
slider9:dbgChickVel=0<0,127,1>(debug) Original Chick vel
slider10:dbgNoteOn=0<0,2,1{-,Chick,Splash}>(debug) Emitted Note on
slider11:dbgNoteVel=0<0,127,1>(debug) Emitted Note vel
slider12:dbgSamplePos=0<0,100000000000,1>(debug) Sample position

in_pin:none
out_pin:none

@init
last_cc4_value = 63.5;
press_start_time = 0;   // sample count at start of press
press_start_value = 0;
last_note_sent = 0;
total_samples = 0;
tracking_active = 0;
last_activity_samples = 0;
dbgChickVel = 0;
dbgNoteOn = 0;
dbgNoteVel = 0;

// Apply curve choice to computed velocity
function apply_curve(norm_val) (
  norm_val = max(0, min(1, norm_val));
  curveType == 0 ? norm_val :
  curveType == 1 ? log(norm_val * 9 + 1) / log(10) :
  curveType == 2 ? exp(norm_val * 2) / exp(2) :
  curveType == 3 ? pow(norm_val, 2) :
  curveType == 4 ? (norm_val < 0.5 ? 2 * norm_val * norm_val : -1 + (4 - 2 * norm_val) * norm_val) :
  curveType == 5 ? pow(norm_val, 3) :
  norm_val;
);

@block
tracking_active && (total_samples - last_activity_samples > 2 * srate) ? tracking_active = 0;

while(midirecv(offset, msg1, msg23)) (
  status = msg1 & 0xF0;
  chan = msg1 & 0x0F;
  data1 = msg23 & 0x7F;
  data2 = (msg23 >> 8) & 0x7F;
  event_samples = total_samples + offset;

  // Track CC4 (pedal position); only start/refresh tracking when gate passed (ignore minor disturbances)
  (status == 0xB0 && data1 == 4) ? (
    // Detect pedal press: closing pedal (toward 127 if closedSide, toward 0 if closed_at_0)
    closing = closedSide ? (data2 > last_cc4_value) : (data2 < last_cc4_value);
    (closing && (abs(data2 - last_cc4_value) >= 1)) ? (
      tracking_active = 1;
      last_activity_samples = event_samples;
      press_start_value = last_cc4_value;
      press_start_time = event_samples;
    );

    last_cc4_value = data2;
    midisend(offset, msg1, msg23);

  ) : (status == 0x90 && data2 > 0 && data1 == chickNote) ? (
    tracking_active = 1;
    last_activity_samples = event_samples;
    dbgChickVel = data2;

    // Detect chick note (Note On)
    chick_on_time = event_samples;
    press_duration_samples = chick_on_time - press_start_time;
    press_duration_ms = press_duration_samples * 1000 / srate;
    (press_start_time == 0 || press_duration_samples > 2 * srate) ? press_duration_ms = 50;

    // Calculate velocity of press
    cc4_change = last_cc4_value - press_start_value;
    press_velocity = (cc4_change / 127) / max(1, press_duration);
    raw_vel = abs(press_velocity) * 1000 * velSensitivity;

    // Determine chick or splash
    is_fast = raw_vel > minVel;
    is_short = press_duration_ms < chickHeld;
    is_chick = is_fast && is_short;

    // Map velocity to MIDI range and apply curve
    norm_vel = (raw_vel - minVel) / (maxVel - minVel);
    curved_vel = apply_curve(norm_vel);
    out_velocity = max(1, min(127, floor(curved_vel * 126 + 1)));

    dbgNoteVel = out_velocity; // set the debug for emitted note on

    // Send chick or splash
    out_note = is_chick ? chickNote : splashNote;
    dbgNoteOn = is_chick ? 1 : 2;

    out_velocity = is_chick ? data2 : out_velocity;
    dbgNoteVel = out_velocity;

    last_note_sent = out_note;
    midisend(offset, 0x90 | chan, out_note | (out_velocity << 8));

  ) : ((status == 0x80 || (status == 0x90 && data2 == 0)) && data1 == chickNote) ? (
    // Note Off for chick - map to whatever we sent
    out_note = last_note_sent;
    midisend(offset, 0x80 | chan, out_note | (data2 << 8));

  ) : (
    // Pass through all other MIDI
    midisend(offset, msg1, msg23);
  );
);

tracking_active ? total_samples += samplesblock;
dbgSamplePos = total_samples;
